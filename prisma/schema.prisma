generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Chain verification status for reorg resilience
// PENDING: Ingested via confirmed commitment, awaiting verification
// FINALIZED: Verified (hash-chain match OR on-chain existence at finalized)
// ORPHANED: Reorg detected, data invalid
// Note: SQLite doesn't support enums, using String with CHECK constraints in migrations

// Agent identity (Core asset)
model Agent {
  id         String   @id // asset pubkey (base58)
  owner      String   // current owner pubkey
  wallet     String?  // agent operational wallet (optional)
  uri        String   // agent URI (IPFS/Arweave/HTTP)
  nftName    String   // NFT display name
  collection String   // collection pubkey
  registry   String   // registry config pubkey
  atomEnabled Boolean @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Transaction reference
  createdTxSignature String?
  createdSlot        BigInt?

  // Verification status (reorg resilience)
  status       String    @default("PENDING") // PENDING | FINALIZED | ORPHANED
  verifiedAt   DateTime?
  verifiedSlot BigInt?

  // Relations
  metadata    AgentMetadata[]
  feedbacks   Feedback[]
  validations Validation[]

  @@index([owner])
  @@index([collection])
  @@index([registry])
  @@index([status])
}

// Agent metadata entries (individual PDAs)
model AgentMetadata {
  id        String  @id @default(uuid())
  agentId   String
  key       String  // metadata key (max 32 bytes)
  value     Bytes   // metadata value (max 256 bytes)
  immutable Boolean @default(false)

  // Transaction reference
  txSignature String?
  slot        BigInt?

  // Verification status (reorg resilience)
  status     String    @default("PENDING") // PENDING | FINALIZED | ORPHANED
  verifiedAt DateTime?

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, key])
  @@index([agentId])
  @@index([status])
}

model Feedback {
  id                 String   @id @default(uuid())
  agentId            String
  client             String
  feedbackIndex      BigInt
  value              BigInt   @default(0)
  valueDecimals      Int      @default(0)
  score              Int?
  tag1               String
  tag2               String
  endpoint           String
  feedbackUri        String
  feedbackHash       Bytes?
  revoked            Boolean  @default(false)
  runningDigest      Bytes?
  createdAt          DateTime @default(now())
  createdTxSignature String?
  createdSlot        BigInt?
  txIndex            Int?
  revokedTxSignature String?
  revokedSlot        BigInt?
  status             String   @default("PENDING")
  verifiedAt         DateTime?

  agent     Agent              @relation(fields: [agentId], references: [id], onDelete: Cascade)
  responses FeedbackResponse[]

  @@unique([agentId, client, feedbackIndex])
  @@index([agentId])
  @@index([client])
  @@index([score])
  @@index([tag1])
  @@index([tag2])
  @@index([status])
}

model FeedbackResponse {
  id            String   @id @default(uuid())
  feedbackId    String
  responder     String
  responseUri   String
  responseHash  Bytes?
  runningDigest Bytes?
  responseCount BigInt?
  createdAt     DateTime @default(now())
  txSignature   String?
  slot          BigInt?
  txIndex       Int?
  status        String   @default("PENDING")
  verifiedAt    DateTime?

  feedback Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  @@unique([feedbackId, responder, txSignature])
  @@index([feedbackId])
  @@index([feedbackId, responder])
  @@index([feedbackId, responseCount])
  @@index([status])
}

model Revocation {
  id            String   @id @default(uuid())
  agentId       String
  client        String
  feedbackIndex BigInt
  feedbackHash  Bytes?
  slot          BigInt
  originalScore Int?
  atomEnabled   Boolean  @default(false)
  hadImpact     Boolean  @default(false)
  runningDigest Bytes?
  revokeCount   BigInt
  txSignature   String?
  txIndex       Int?
  createdAt     DateTime @default(now())
  status        String   @default("PENDING")
  verifiedAt    DateTime?

  @@unique([agentId, client, feedbackIndex])
  @@index([agentId])
  @@index([status])
}

model OrphanResponse {
  id            String   @id @default(uuid())
  agentId       String
  client        String
  feedbackIndex BigInt
  responder     String
  responseUri   String
  responseHash  Bytes?
  createdAt     DateTime @default(now())
  txSignature   String?
  slot          BigInt?

  @@unique([agentId, client, feedbackIndex, responder, txSignature])
  @@index([agentId])
  @@index([agentId, client, feedbackIndex])
}

// Validation requests and responses
model Validation {
  id           String    @id @default(uuid())
  agentId      String
  validator    String    // validator pubkey
  requester    String    // who requested validation
  nonce        BigInt    // unique nonce for this agent+validator (u64 on-chain)
  requestUri   String?   // URI to validation request (null if orphan response)
  requestHash  Bytes?    // SHA-256 hash of request (null if all-zero/IPFS or orphan)
  response     Int?      // validator response (0-100, null if pending)
  responseUri  String?   // URI to response
  responseHash Bytes?    // SHA-256 hash of response
  tag          String?   // validation tag/category
  createdAt    DateTime  @default(now())
  respondedAt  DateTime?

  // Transaction references
  requestTxSignature  String?
  requestSlot         BigInt?
  responseTxSignature String?
  responseSlot        BigInt?

  // Verification status (reorg resilience - existence verified)
  // Named chainStatus to avoid conflict with existing validation status field
  chainStatus     String    @default("PENDING") // PENDING | FINALIZED | ORPHANED
  chainVerifiedAt DateTime?

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, validator, nonce])
  @@index([agentId])
  @@index([validator])
  @@index([requester])
  @@index([chainStatus])
}

// Registry configurations (Base and User)
model Registry {
  id           String   @id // registry config pubkey
  collection   String   @unique // collection pubkey
  registryType String   // "Base" | "User"
  authority    String   // authority pubkey
  createdAt    DateTime @default(now())

  // Transaction reference
  txSignature String?
  slot        BigInt?

  // Verification status (reorg resilience - existence verified)
  status     String    @default("PENDING") // PENDING | FINALIZED | ORPHANED
  verifiedAt DateTime?

  @@index([registryType])
  @@index([authority])
  @@index([status])
}

// Indexer state for cursor management
model IndexerState {
  id            String   @id @default("main")
  lastSignature String?  // last processed transaction signature
  lastSlot      BigInt?  // last processed slot
  source        String   @default("poller") // "websocket" | "poller"
  updatedAt     DateTime @updatedAt
}

// Agent digest cache for hash-chain verification (Feedback/Response/Revoke)
// Stores on-chain digest values to compare against computed DB digests
model AgentDigestCache {
  agentId          String    @id
  feedbackDigest   Bytes?    // Last verified on-chain digest
  feedbackCount    BigInt    @default(0)
  responseDigest   Bytes?
  responseCount    BigInt    @default(0)
  revokeDigest     Bytes?
  revokeCount      BigInt    @default(0)
  lastVerifiedAt   DateTime?
  lastVerifiedSlot BigInt?
  needsGapFill     Boolean   @default(false)
  gapFillFromSlot  BigInt?
}

model HashChainCheckpoint {
  id         Int      @id @default(autoincrement())
  agentId    String
  chainType  String
  eventCount Int
  digest     String
  createdAt  DateTime @default(now())

  @@unique([agentId, chainType, eventCount])
  @@index([agentId, chainType])
}

// Event log for debugging and replay
model EventLog {
  id          String   @id @default(uuid())
  eventType   String   // event discriminator name
  signature   String   // transaction signature
  slot        BigInt
  blockTime   DateTime
  data        Json     // raw event data
  processed   Boolean  @default(false)
  error       String?  // error message if processing failed
  createdAt   DateTime @default(now())

  @@index([eventType])
  @@index([signature])
  @@index([slot])
  @@index([processed])
}
